services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null http://localhost:8000"]
      interval: 5s
      timeout: 3s
      retries: 5

  create-table:
    image: amazon/aws-cli:latest
    depends_on:
      dynamodb-local:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: [""]
    command: >
      aws dynamodb create-table
        --endpoint-url http://dynamodb-local:8000
        --table-name user-preferences
        --attribute-definitions AttributeName=PK,AttributeType=S
        --key-schema AttributeName=PK,KeyType=HASH
        --billing-mode PAY_PER_REQUEST

  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      create-table:
        condition: service_completed_successfully
    environment:
      SERVER_PORT: "8080"
      DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      DYNAMODB_TABLE_NAME: user-preferences
      JWT_SECRET: local-dev-secret-do-not-use-in-prod
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      LOG_LEVEL: debug
      DEV_BYPASS_AUTH: "true"
